# Router OS 架构设计文档

## 概述

Router OS 是一个使用 Go 语言实现的简化路由器操作系统，旨在演示现代路由器的核心功能和架构设计。

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        Router OS                           │
├─────────────────────────────────────────────────────────────┤
│  CLI Interface          │  Configuration Manager           │
│  - 命令行交互            │  - JSON 配置文件                  │
│  - 实时控制              │  - 动态配置更新                   │
├─────────────────────────┼─────────────────────────────────┤
│  Logging System         │  Monitoring System              │
│  - 分级日志              │  - 系统状态监控                   │
│  - 文件/控制台输出        │  - 性能指标收集                   │
├─────────────────────────────────────────────────────────────┤
│                    Router Core                             │
│  ┌─────────────────┬─────────────────┬─────────────────┐   │
│  │  Routing Table  │ Interface Mgr   │ Packet Processor│   │
│  │  - 路由表管理    │ - 接口发现       │ - 数据包处理     │   │
│  │  - 最长前缀匹配  │ - 状态监控       │ - 转发决策       │   │
│  │  - 路由老化      │ - 统计信息       │ - 本地交付       │   │
│  └─────────────────┴─────────────────┴─────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│                  Protocol Stack                            │
│  ┌─────────────────┬─────────────────────────────────────┐ │
│  │  Static Routes  │           RIP Protocol              │ │
│  │  - 静态路由配置  │  - 距离向量算法                      │ │
│  │  - 手动管理      │  - 定期更新                         │ │
│  │                 │  - 邻居发现                         │ │
│  └─────────────────┴─────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. Router Core (`internal/router/`)

路由器的核心组件，负责协调各个子系统的工作。

**主要功能：**
- 系统初始化和启动
- 组件生命周期管理
- 子系统间的协调

**关键接口：**
```go
type Router struct {
    routingTable    *routing.Table
    interfaceManager *interfaces.Manager
    packetProcessor *packet.Processor
    // ...
}

func (r *Router) Start() error
func (r *Router) Stop() error
```

### 2. Routing Table (`internal/routing/`)

实现路由表的核心数据结构和算法。

**主要功能：**
- 路由条目的增删改查
- 最长前缀匹配算法
- 路由度量值比较
- 动态路由老化机制

**数据结构：**
```go
type Route struct {
    Destination *net.IPNet    // 目标网络
    Gateway     net.IP        // 网关
    Interface   string        // 出接口
    Metric      int           // 路由度量值
    Type        RouteType     // 路由类型
    Age         time.Time     // 路由创建时间
    TTL         time.Duration // 生存时间
}
```

**算法特点：**
- 使用切片存储路由条目
- 按前缀长度和度量值排序
- 支持并发安全访问（读写锁）

### 3. Interface Manager (`internal/interfaces/`)

网络接口管理组件，负责发现和管理系统网络接口。

**主要功能：**
- 自动发现系统网络接口
- 接口状态监控
- 接口统计信息收集
- 接口配置管理

**接口状态：**
- `InterfaceStatusDown` - 接口关闭
- `InterfaceStatusUp` - 接口启用
- `InterfaceStatusTesting` - 接口测试中

### 4. Packet Processor (`internal/packet/`)

数据包处理引擎，实现数据包的接收、处理和转发。

**主要功能：**
- 数据包类型识别
- 转发决策制定
- 本地数据包交付
- 数据包统计

**数据包类型：**
- IPv4 数据包
- IPv6 数据包
- ARP 数据包
- 其他协议数据包

### 5. Protocol Stack (`internal/protocols/`)

路由协议实现，目前支持静态路由和 RIP 协议。

#### 5.1 Static Routes (`static.go`)

静态路由管理器，提供手动路由配置功能。

**特点：**
- 永久有效（不会老化）
- 手动配置和删除
- 高优先级（低度量值）

#### 5.2 RIP Protocol (`rip.go`)

实现 RIP（Routing Information Protocol）距离向量路由协议。

**协议特性：**
- 距离向量算法
- 最大跳数限制（15跳）
- 定期更新机制
- 水平分割防环
- 路由老化和垃圾回收

**RIP 数据包格式：**
```go
type RIPPacket struct {
    Command byte        // 命令类型
    Version byte        // 版本号
    Entries []RIPEntry  // 路由条目
}

type RIPEntry struct {
    Network *net.IPNet  // 目标网络
    Metric  int         // 跳数
}
```

### 6. Configuration Manager (`internal/config/`)

配置管理系统，支持 JSON 格式的配置文件。

**配置项：**
- 网络接口配置
- 静态路由配置
- RIP 协议参数
- 系统参数

**配置文件结构：**
```json
{
  "interfaces": [...],
  "static_routes": [...],
  "rip": {
    "enabled": true,
    "update_interval": 30,
    "timeout": 180,
    "garbage_collection": 120
  }
}
```

### 7. CLI Interface (`internal/cli/`)

命令行接口，提供实时的系统管理和监控功能。

**支持的命令：**
- `show routes` - 显示路由表
- `show interfaces` - 显示接口状态
- `show stats` - 显示系统统计
- `add route` - 添加静态路由
- `del route` - 删除路由
- `rip start/stop` - RIP 协议控制

### 8. Logging System (`internal/logging/`)

分级日志系统，支持多种输出目标。

**日志级别：**
- DEBUG - 调试信息
- INFO - 一般信息
- WARN - 警告信息
- ERROR - 错误信息

**输出目标：**
- 控制台输出
- 文件输出
- 可配置的日志轮转

### 9. Monitoring System (`internal/monitoring/`)

系统监控组件，收集和报告系统运行状态。

**监控指标：**
- 系统运行时间
- 内存使用情况
- Goroutine 数量
- 路由表大小
- 接口统计信息
- 数据包处理统计

## 数据流

### 1. 路由更新流程

```
配置文件/CLI → 配置管理器 → 静态路由管理器 → 路由表
RIP 协议 → RIP 管理器 → 路由表
```

### 2. 数据包处理流程

```
网络接口 → 数据包处理器 → 路由表查找 → 转发决策 → 出接口
```

### 3. 监控数据流程

```
各组件 → 监控系统 → 统计信息聚合 → CLI/日志输出
```

## 并发模型

系统采用 Go 语言的 goroutine 并发模型：

1. **主 goroutine**: 系统初始化和信号处理
2. **RIP 协议 goroutine**: 定期更新和邻居超时检查
3. **监控 goroutine**: 定期收集系统统计信息
4. **CLI goroutine**: 处理用户命令输入
5. **数据包处理 goroutine**: 处理入站数据包

## 同步机制

- **读写锁**: 路由表访问保护
- **互斥锁**: 接口管理器状态保护
- **通道**: 组件间异步通信
- **上下文**: 优雅关闭控制

## 扩展性设计

### 1. 新协议支持

添加新的路由协议只需：
1. 在 `internal/protocols/` 下实现协议逻辑
2. 在路由器核心中注册协议
3. 更新配置管理器支持新协议参数

### 2. 新功能模块

系统采用模块化设计，新功能可以作为独立模块添加：
1. 实现模块接口
2. 在路由器核心中集成
3. 更新 CLI 支持新命令

### 3. 性能优化

- 路由表可以替换为更高效的数据结构（如 Trie 树）
- 数据包处理可以使用零拷贝技术
- 添加缓存机制减少路由查找开销

## 测试策略

### 1. 单元测试

每个组件都有对应的单元测试：
- 路由表操作测试
- 协议逻辑测试
- 配置解析测试

### 2. 集成测试

- 组件间交互测试
- 端到端功能测试
- 性能基准测试

### 3. 示例程序

提供完整的功能演示程序，展示系统各项功能。

## 部署和运维

### 1. 构建

使用 Makefile 简化构建过程：
```bash
make build    # 构建可执行文件
make test     # 运行测试
make demo     # 运行演示
```

### 2. 配置

通过 JSON 配置文件进行系统配置，支持运行时重新加载。

### 3. 监控

内置监控系统提供实时的系统状态信息，便于运维管理。

## 安全考虑

1. **输入验证**: 所有外部输入都进行严格验证
2. **权限控制**: CLI 命令需要适当的权限检查
3. **资源限制**: 防止资源耗尽攻击
4. **日志安全**: 避免敏感信息泄露

## 性能特性

- **内存效率**: 使用高效的数据结构
- **并发处理**: 支持多核并行处理
- **低延迟**: 优化的路由查找算法
- **高吞吐**: 批量处理机制

## 限制和已知问题

1. 这是一个教学和演示用的简化实现
2. 不支持硬件数据平面加速
3. RIP 协议实现不包括所有 RFC 特性
4. 缺少高级安全功能
5. 不适合生产环境使用

## 未来发展方向

1. 支持更多路由协议（OSPF、BGP）
2. 添加 QoS 功能
3. 实现 MPLS 支持
4. 添加 Web 管理界面
5. 支持 SDN 控制器集成